#!/usr/bin/python
import tarfile
import os
import sys
import json
import urllib2
import io
import argparse
from installer import install, uninstall, plugin_config_file
from web import get_from_web

parser = argparse.ArgumentParser(
    usage="gpi [command] [package]\n       gpi install -f [file]")

parser.add_argument('command', nargs='+')
parser.add_argument("-f", "--file", help="install from file", default=False,
                    action="store")
args = parser.parse_args()

if args.file and args.command[0] != "install":
    exit("Cannot uninstall from a file!")

if args.file and len(args.command) > 1:
    exit("Specify either a file or a package name!")

if len(args.command) < 2 and not args.file:
    exit("Usage: gpi [command] [package]")


def main():
    if args.command[0] == "install":
        if args.file:
            if not tarfile.is_tarfile(args.file):
                exit("File must be a tarfile!")
            t = tarfile.open(args.file, 'r')
            filename = args.file
        else:
            t = get_from_web(args.command[1], host)
            exit()

        manifest = json.load(t.extractfile('gpi.json'))
        print("Installing " + manifest['name'] + " from " + filename)
        install(t, manifest)
        print("{} {} installed successfully!".format(
            manifest['name'], manifest['version']))

    elif args.command[0] == "uninstall":
        config = plugin_config_file(args.command[1])
        if not os.path.isfile(config):
            exit(args.command[1] + " is not installed!")
        uninstall(config)
        print("{} uninstalled successfully!".format(args.command[1]))

if __name__ == "__main__":
    sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
    main()
